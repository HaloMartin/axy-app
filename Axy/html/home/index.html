<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../js/common/flexible.js"></script>

		<link href="../../css/lib/mui.min.css" rel="stylesheet" />

		<link rel="stylesheet" href="../../css/app/app.css" />
		<style type="text/css">
			header img {
				width: 0.48rem;
			}
			
			.mui-bar-nav~.mui-content {
				padding-top: 0;
			}
			
			.mui-slider-indicator .mui-indicator {
				background: transparent;
				margin: 0 1.5px;
				border: .5px white solid;
			}
			
			.mui-slider-item {
				width: 100%;
				height: 0 !important;
				padding-top: 50.6666%;
				background-size: cover;
				background-position: center;
			}
			
			.model_type {
				background-color: white;
			}
			
			.model_type>div {
				padding: 0.32rem 0;
				display: inline-block;
				/*//修改20%-->25%*/
				width: 25%;
				text-align: center;
			}
			
			.model_type>div>img {
				width: 1.04rem;
			}
			/*3轮播head阴影*/
			/*.mui-slider{
				position: relative;
			}
			.mui-slider:before{
				z-index: 10;
				content: "";
				height: 0;
				width: 100%;
				position: absolute;
				left: 0;top: 0;
				filter:alpha(opacity=100 finishopacity=50 style=1 startx=0,starty=0,finishx=0,finishy=150) progid:DXImageTransform.Microsoft.gradient(startcolorstr=red,endcolorstr=blue,gradientType=0);
			    background: transparent;
			    background:-webkit-gradient(linear, 0 0, 0 bottom, from(rgba(0, 0, 0, 1)), to(rgba(255, 255, 255, 0.2))); 
			}*/
			/*3end*/
			
			.dev_menu>div {
				padding: 0.2rem 0;
				vertical-align: middle;
				display: inline-block;
			}
			
			.dev_menu .mui-icon img {
				width: 0.506666rem;
			}
			
			.dev_menu .mui-icon>* {
				vertical-align: middle;
			}
			
			.dev_menu .d1 {
				width: 50%;
				overflow: hidden;
			}
			
			.dev_menu .d1>span {
				width: 80%;
				white-space: nowrap;
				display: inline-block;
			}
			
			.dev_menu .d2 {
				width: 20%;
			}
			
			.dev_menu .d3 {
				width: 24%;
				text-align: right;
			}
			
			.card {
				background-color: white !important;
				margin-top: 0.266666rem;
			}
			
			.card_head {
				padding: 0 0.346666rem;
				color: #646464;
			}
			
			.card_head>* {
				height: 0.986666rem;
				line-height: 0.986666rem;
			}
			
			.card_head .mui-icon>* {
				line-height: 0.986666rem;
				vertical-align: middle;
				color: #A8A8A9;
			}
			
			.card_head img {
				width: .17rem;
			}
			
			.model_type>div>span {
				display: block;
				color: #2E2E2E;
				margin-top: 0.266666rem;
			}
			/*设备影像*/
			
			.device_show {
				padding: 0 0.28rem 0 0.28rem;
				background: white;
				position: relative;
			}
			/*设备预览图*/
			
			.device_show>.img {
				width: 100%;
				padding-top: 50%;
				background-size: cover;
				background-position: center;
			}
			/*设备状态*/
			
			.device_show .dev_status {
				position: absolute;
				background-color: #2bb8aa;
				width: 0.76rem;
				height: 0.4rem;
				color: #f5fbfa;
				right: 0.626666rem;
				top: 0.306666rem;
				line-height: 0.4rem;
				text-align: center;
				border-radius: 2px;
			}
			
			.device_show .dev_status.offline {
				background-color: #9F9FA0;
			}
			/*设备名称及菜单====start====*/
			/*设备名称及菜单====end====*/
			/*猜你喜欢====start====*/
			
			.user_like {
				background-color: white;
				margin-top: 0.266666rem;
				padding: 0.346666rem;
			}
			
			.like_image {
				padding: 0 0.266666rem;
				width: 100%;
				overflow: hidden;
				/*height: 230px;*/
			}
			
			.like_image>div {
				float: left;
				position: relative;
				margin: 0 1%;
				width: 48%;
				height: 0 !important;
				padding-bottom: 30%;
				margin-bottom: 2%;
				background-size: cover;
				background-position: center;
			}
			
			.like_image>div>img {
				width: 100%;
			}
			
			.like_image>div>span {
				position: absolute;
				bottom: 17%;
				/*transform: translateX(-50%);*/
				color: #FFFFFF;
				font-size: 1.2rem;
				width: 100%;
				text-align: center;
			}
			/*猜你喜欢====end====*/
			/*附近的店====start====*/
			
			.near_shop {
				background-color: white;
				margin-top: 12px;
				padding: 16px;
			}
			
			.near_title {
				font-size: 14px;
				color: #646464;
			}
			
			.shop_image {
				padding: 0 0.266666rem 0.32rem 0;
				overflow-x: scroll;
				overflow-y: hidden;
				white-space: nowrap;
			}
			
			.shop_image>div {
				display: inline-block;
				border: 1px solid #ccc;
				box-sizing: content-box;
				height: 0;
				margin: 0 1%;
				width: 31.33%;
				padding-bottom: 31.33%;
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
			}
			/*附近的店====end====*/
		</style>

		<link rel="stylesheet" href="new_file.css" />
	</head>

	<body>
		<div id="approom">

			<header class="mui-bar mui-bar-nav mui-bar-transparent" data-top='0' data-offset='150' data-duration='16'>
				<a class="mui-icon mui-pull-left">
					<img src="../../image/home/message.png" />
				</a>
				<h1 class="mui-title"></h1>
				<a class="mui-icon mui-pull-right" @tap="onPlusTap()">
					<img src="../../image/home/plus.png" />
				</a>
				<a class="mui-icon mui-pull-right" style="margin-right: 0.133333rem;" @tap="onSearchTap()">
					<img src="../../image/home/search.png" />
				</a>
			</header>

			<div class="mui-content noImmersed">
				<!--<div class="mui-scroll">-->

				<div id="slider" class="mui-slider" v-if="imgList.length > 0">
					<div class="mui-slider-group mui-slider-loop">
						<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
						<div @tap="onAdvertTap(imgLast)" class="mui-slider-item mui-slider-item-duplicate img-lazy-load" :data-src="imgLast.adimg">
							<!--<a href="#">
							<img :src="imgLast.src">
						</a>-->
						</div>

						<!-- 第四张 -->
						<div @tap="onAdvertTap(o)" class="mui-slider-item img-lazy-load" v-for="o, index in imgList" :data-src="o.adimg">
							<a href="#">
								<img :src="o.src">
							</a>
						</div>
						<!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
						<div @tap="onAdvertTap(imgFrist)" class="mui-slider-item mui-slider-item-duplicate img-lazy-load" :data-src="imgFrist.adimg">
							<!--<a href="#">
							<img :src="imgFrist.src">
						</a>-->
						</div>
					</div>
					<div class="mui-slider-indicator">
						<div v-for="o, index in imgList" class="mui-indicator" :class="index === 0 ? 'mui-active':''"></div>
					</div>
				</div>

				<div class="model_type">
					<template v-for="o,i in modelTypes">
						<div @tap="onModelTap(o, i)">

							<img :src="o.src" />
							<span class="app-font-size-24">{{o.name}}</span>
						</div>
					</template>

				</div>
				<template v-if="dev.devid">
					<div class="card">
						<div class="card_head">
							<span class="app-font-size-28">我的设备</span>
							<div @tap="onDeviceMore()" class="app-font-size-24 mui-pull-right">

								<span class="mui-icon">
								<span class="app-font-size-24">查看更多</span>
								<img src="../../image/home/see_more.png" />
								</span>
							</div>
						</div>

						<div class="device_show">
							<div class="img" :style="{backgroundImage: 'url('+'file:////storage/emulated/0/CameraFamily/Thumbnail/'+dev.devid+'.jpeg'+')'}" @tap="openCamListWindow()">

							</div>
							<div class="dev_status app-font-size-22" :class="dev.online === 1? '':'offline'">{{dev.online === 1 ? '在线': '离线'}}</div>
							<div class="dev_menu">
								<div class="mui-icon d1">
									<img src="../../image/home/dev_camera.png" />
									<span class="app-font-size-24 app-color-main">{{dev.devid}}</span>
								</div>

								<div class="mui-icon d2">
									<img src="../../image/home/dev_share.png" />
									<span class="app-font-size-24" style="color: #696969;">分享</span>
								</div>
								<div class="mui-icon d3" @tap="onDeviceSetTap()">
									<img src="../../image/home/dev_setting.png" />
									<span class="app-font-size-24" style="color: #696969;">设置</span>
								</div>

							</div>
						</div>
					</div>
				</template>
				<template v-else>
					<div style="text-align: center;">
						<img @tap="addDeviceTap()"  src="../../image/home/btn_Adddevice@3x.png" style="width: 1.893333rem;margin-top: 1.413333rem;"/>
						<div class="app-font-size-28 app-color-main" style="margin-top: 0.266666rem;margin-bottom: 1.12rem;">添加设备</div>
						<div class="app-font-size-28 app-color-333333" style="margin: 0.453333rem 0;">这里空空如也，快让你的设备智能起来吧~</div>
					</div>
				</template>

				<!--v-if="like.length"-->
				<div class="card">
					<div class="card_head">
						<span class="app-font-size-28">猜你喜欢</span>
						<div @tap="onStoreMore()" class="app-font-size-24 mui-pull-right">

							<span class="mui-icon">
								<span class="app-font-size-24">查看更多</span>
							<img src="../../image/home/see_more.png" />
							</span>
						</div>
					</div>

					<div class="like_image">

						<template v-for="o,i in like">
							<div :style="{backgroundImage: 'url('+o.img+')'}" @tap="onLikeItemTap(o)">

								<span class="app-font-size-24">{{o.title}}</span>
							</div>
						</template>

						<!--<div>
							<img src="../../image/home/like_a.png" />
							<span>舌尖上的诱惑</span>
						</div>
						<div>
							<img src="../../image/home/like_b.png" />
							<span>周末来嗨呀</span>
						</div>

						<div>
							<img src="../../image/home/like_c.png" />
							<span>限时特惠</span>
						</div>
						<div>
							<span>一起来看红包雨</span>
							<img src="../../image/home/like_d.png" />
						</div>-->

					</div>
				</div>
				<div class="card" style="margin-bottom: 0.266666rem;">
					<div class="card_head">
						<span class="app-font-size-28">附近的店</span>
						<div @tap="onNearbyMore()" class="app-font-size-24 mui-pull-right">

							<span class="mui-icon">
								<span class="app-font-size-24">查看更多</span>
							<img src="../../image/home/see_more.png" />
							</span>
						</div>
					</div>
					<div class="shop_image">
						<template v-for="o,i in nearShops">
							<div @tap="onNearItemTap(o)" class="shop_a" :style="'background-image: url('+ _getImg(o.image1,o.image2,o.image3) +');'"></div>
						</template>

					</div>
				</div>

				<!--</div>-->

			</div>
		</div>
		<!--沉浸式动态处理-->
		<script type="text/javascript" src="../../js/common/immersed.js"></script>

		<!--基础配置-->
		<script type="text/javascript" src="../../js/config.js"></script>
		<!--基础库-->
		<script type="text/javascript" src="../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue-ni.js"></script>
		<!--请求相关-->
		<script type="text/javascript" src="../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../js/dal/user.js"></script>
		<script type="text/javascript" src="../../js/dal/home.js"></script>
		<script type="text/javascript" src="../../js/dal/device.js"></script>
		<script type="text/javascript" src="../../js/dal/store.js"></script>
		<!--App相关业务逻辑-->
		<script type="text/javascript" src="../../js/app/app.js"></script>
		<script type="text/javascript" src="../../js/app/app-page.js"></script>

		<!--<script type="text/javascript" src="../../js/plug/test.js" ></script>-->
		<script type="text/javascript" src="../../js/lib/md5.min.js"></script>
		<script type="text/javascript" src="../../js/common/imagelazyload.js"></script>

		<script type="text/javascript" src="../../js/plug/PlugDevManager.js"></script>
		<script type="text/javascript" src="../../js/plug/PlugH5NativeBridge.js"></script>
		<script type="text/javascript" src="../../js/lib/Rx.min.js"></script>

		<script type="text/javascript">
			var advert_cache = new ni.Cache('advert_cache', []);

			var B = new ni.Broadcast();

			var runManager, devManager;

			mui.init({
				gestureConfig: {
					longtap: true
				}
			});
			var vm = new Vue({
				el: '#approom',
				data: function() {
					return {

						imgList: advert_cache.data,
						modelTypes: [{
								name: "回家模式",
								src: "../../image/home/gohome.png"
							},
							{
								name: "离家模式",
								src: "../../image/home/outhome.png"
							},
							{
								name: "回店模式",
								src: "../../image/home/goshop.png"
							},
							{
								name: "离店模式",
								src: "../../image/home/outshop.png"
							}
						],
						dev: {
							"streamfwdport": 0,
							"location": "",
							"devid": "",
							"relation": 0,
							"streamfwd": "",
							"type": 1,
							"signalfwd": "",
							"signalfwdport": 0,
							"online": 1
						},
						localDev: {
							
						},
						
						like: [

						],

						nearShops: [],

						longitude: 0,
						latitude: 0,
						city: '深圳',

					};
				},

				computed: {
					imgFrist: function() {
						return this.imgList[0];
					},
					imgLast: function() {
						return this.imgList[this.imgList.length - 1];
					}
				},
				mounted: function() {
					// 获取轮播广告图
					this.getAdvert();

					// 获取喜欢列表
					this.getThemeList();

					// 动态沉浸式处理
					//					var css = document.createElement('style');
					//					css.innerText = ".mui-slider:before{height:"+ (immersed) +"px;}";
					//					document.body.appendChild(css);
					// 缓存机制加载图片
					imagelazyload();
					// 图片轮播
					mui('#slider').slider({
						interval: 3000 // 自动轮播周期，若为0则不自动播放，默认为0
					});
				},
				plusReady: function() {
					var that = this;

					// 本地 所有设备的信息
					var ALLD = new ni.Cache('AllDeviceInfo', [], {
						plus: true
					});

					// 本地 所有设备的运行状态
					var ALLR = new ni.Cache('AllDeviceRun', [], {
						plus: true
					});

					devManager = new DevManager(ALLD);
					runManager = new DevManager(ALLR);

					//如果用户登录了 则  获取第一个设备
					if(app.user.has()) {
						this.getDeviceOne();
					}
					// 同时监听登录成功事件
					new this.$Broadcast().on('login_success', function() {
						// 更新获取设备
						this.getDeviceOne();
					}.bind(this));

					// plus ready ! 现在可以使用plus相关api
					// 设置本页面无滚动条显示
					this.$view.setStyle({
						scrollIndicator: "none", // 隐藏滚动条
						render: "always", // 始终进行渲染
					});

					// 获取定位信息
					this.getCurrentPosition().then(function() {
						// 附近的店
						this.getNearShops();
					}.bind(this)).catch(function(){
						this.getNearShops();
					}.bind(this));

					// 监听设备变化
					this.listenDev();

				},
				methods: {
					getCurrentPosition: function() {
						return new Promise(function(re, rj) {
							plus.geolocation.getCurrentPosition(function(p) {
								this.longitude = p.coords.longitude;
								this.latitude = p.coords.latitude;
								this.city = p.address.city.replace('市', '');
								this.position = p.address.poiName;
								re();
							}.bind(this), rj);
						}.bind(this));
					},
					
					// 点击搜索按钮
					onSearchTap: function() {
						mui.openWindow('../search/index.html', 'search', {
							show: {
								aniShow: 'slide-in-bottom'
							}
						});
					},
					// 点击添加按钮
					onPlusTap: function(){
						
						mui.openWindow('../smart/add/add_device.html', 'add/add_device.html');
					},

					// 当点击模式时
					onModelTap: function(o, index) {
						console.log(JSON.stringify(o));
					},

					openCamListWindow: function() {
						plug.H5NativeBridge.StartDevicePlay(this.dev.devid);
					},

					// 获取轮播广告图
					getAdvert: function() {
						dal.home.advert(function(err, data) {
							if(err) {
								return
							}
							this.imgList = data;
							advert_cache.data = data;
							this.$nextTick(function() {
								imagelazyload();
							});
						}.bind(this));
					},
					// 轮播点击
					onAdvertTap: function(o) {
						// 打开内部浏览器
						app.page.openBrowser({
							url: o.adlink
						});
					},
					// 获取一个设备
					getDeviceOne: function() {
						dal.device.list(1, function(err, data) {
							if(err) {
								return
							}
							this.dev = data[0];

						}.bind(this), 1);
					},
					// 监听设备变化
					listenDev: function() {
						B.on('RunstateNotify', function(data) {
							// if(data.add)
							if(data.info.devid === this.dev.devid) {
								this.dev = data.info;
							}
						}.bind(this));
					},

					// 获取喜欢列表
					getThemeList: function() {
						dal.home.theme.get(function(err, data) {
							if(err) {
								return
							}
							this.like = data;
						}.bind(this));
					},
					// 猜你喜欢点击
					onLikeItemTap: function(o) {
						// 打开内部浏览器
						app.page.openBrowser({
							url: o.link
						});
					},
					// 附近的店
					getNearShops: function() {
						dal.store.list(this.longitude, this.latitude, this.city, function(err, data) {
							if(err) {
								return;
							}
							this.nearShops = data;
						}.bind(this), 1);
					},
					// 附近的店点击
					onNearItemTap: function(o) {
						// 店铺
						mui.openWindow('../nearby/business/store_details.html', 'store_details', {
							extras: {
								oid: o.id
							}
						});
					},

					// 设备设置点击
					onDeviceSetTap: function() {
						var id = this.dev.devid;

						var localInfo = devManager.selectByWhere(function(o) {
								return o.basicInfo && o.basicInfo.devid === id;
							}),
							runInfo = runManager.selectByWhere(function(o) {
								return o.devid = id
							});

						mui.openWindow('../smart/devices/camera_settings.html', 'camera_settings', {
							extras: {
								localInfo: localInfo,
								runInfo: runInfo,
								netInfo: this.dev
							}
						});
					},

					_getImg: function(img1, img2, img3) {
						return img1 || img2 || img3;
					},

					// 查看猜你喜欢更多
					onStoreMore: function() {

						B.emit('tabar', {
							mindex: 2,
							nindex: 1
						}, {
							views: [this.$view.parent()],
						});
					},

					// 查看附近的店更多
					onNearbyMore: function() {
						// TODO 主页名称
						B.emit('tabar', {
							mindex: 2,
							nindex: 0
						}, {
							views: [this.$view.parent()],
						});
					},
					// 查看我的设备
					onDeviceMore: function() {
						mui.openWindow('../smart/devices/dev_my_list.html');
					},

					addDeviceTap: function() {
						B.emit('tabar', {
							mindex: 1,
							nindex: 0
						}, {
							views: [this.$view.parent()],
						});
					},
				}
			});
		</script>
	</body>

</html>