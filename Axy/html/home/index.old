<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/app/app.css" />
		<style type="text/css">
			header {
				padding-left: 2rem !important;
				padding-right: 2rem !important;
			}
			
			header a img {
				width: 2rem;
			}
			
			.mui-bar-nav~.mui-content {
				padding-top: 0;
			}
			
			.mui-slider-indicator .mui-indicator {
				background: transparent;
				margin: 0 1.5px;
				border: .5px white solid;
			}
			
			.mui-slider-item {
				width: 100%;
				height: 0 !important;
				padding-top: 50.6666%;
				background-size: cover;
				background-position: center;
			}
			
			.model_type {
				background-color: white;
				padding: 1rem 0;
			}
			
			.model_type>div {
				padding: 1rem 0;
				display: inline-block;
				/*//修改20%-->25%*/
				width: 25%;
				text-align: center;
			}
			
			.model_type>div>img {
				width: 50%;
			}
			/*3轮播head阴影*/
			/*.mui-slider{
				position: relative;
			}
			.mui-slider:before{
				z-index: 10;
				content: "";
				height: 0;
				width: 100%;
				position: absolute;
				left: 0;top: 0;
				filter:alpha(opacity=100 finishopacity=50 style=1 startx=0,starty=0,finishx=0,finishy=150) progid:DXImageTransform.Microsoft.gradient(startcolorstr=red,endcolorstr=blue,gradientType=0);
			    background: transparent;
			    background:-webkit-gradient(linear, 0 0, 0 bottom, from(rgba(0, 0, 0, 1)), to(rgba(255, 255, 255, 0.2))); 
			}*/
			/*3end*/
			
			.model_type>div>span {
				display: block;
				color: #2e2e2e;
				margin-top: 5px;
				font-size: 1.4rem;
			}
			/*设备影像*/
			
			.device_show {
				margin-top: 12px;
				padding: 20px 16px 0 16px;
				background: white;
				position: relative;
			}
			/*设备预览图*/
			
			.device_show>img {
				width: 100%;
			}
			/*设备状态*/
			
			.device_show .dev_status {
				position: absolute;
				background-color: #2bb8aa;
				width: 42px;
				height: 22px;
				color: #f5fbfa;
				right: 30px;
				font-size: 11px;
				top: 34px;
				text-align: center;
				border-radius: 2px;
			}
			/*设备名称及菜单====start====*/
			
			.dev_info,
			.dev_operating,
			.dev_operating>div {
				display: inline-block;
				width: 49%;
				font-size: 12px;
			}
			
			.dev_info {
				color: #2BB8AA;
			}
			
			.dev_operating {
				float: right;
				color: #696969;
			}
			
			.dev_setting {
				text-align: right;
			}
			
			.dev_info img,
			.dev_operating img {
				height: 20px;
				width: 20px;
				vertical-align: middle;
			}
			
			.dev_info,
			.dev_operating {
				margin: 6px 0 16px 0;
			}
			/*设备名称及菜单====end====*/
			/*猜你喜欢====start====*/
			
			.user_like {
				background-color: white;
				margin-top: 12px;
				padding: 16px;
			}
			
			.like_title {
				font-size: 14px;
				color: #646464;
			}
			
			.see_more {
				float: right;
				font-size: 12px;
				color: #a8a8a9;
			}
			
			.see_more>img {
				width: 6px;
				margin-left: 2px;
			}
			
			.like_image {
				width: 100%;
				margin-top: 10px;
				overflow: hidden;
				/*height: 230px;*/
			}
			
			.like_image>div {
				float: left;
				position: relative;
				margin: 0 1%;
				width: 48%;
				height: 0 !important;
				padding-bottom: 30%;
				margin-bottom: 2%;
				background-size: cover;
				background-position: center;
			}
			
			.like_image>div>img {
				width: 100%;
			}
			
			.like_image>div>span {
				position: absolute;
				bottom: 17%;
				/*transform: translateX(-50%);*/
				color: #FFFFFF;
				font-size: 1.2rem;
				width: 100%;
				text-align: center;
			}
			/*猜你喜欢====end====*/
			/*附近的店====start====*/
			
			.near_shop {
				background-color: white;
				margin-top: 12px;
				padding: 16px;
			}
			
			.near_title {
				font-size: 14px;
				color: #646464;
			}
			
			.shop_image {
				margin-top: 10px;
				overflow-x: scroll;
				white-space: nowrap;
			}
			
			.shop_image>div {
				display: inline-block;
				border: 1px solid #ccc;
				box-sizing: border-box;
				height: 0;
				margin: 0 1%;
				width: 31.33%;
				padding-bottom: 31.33%;
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
			}
			/*附近的店====end====*/
		</style>
	</head>

	<body>
		<div id="approom">

			<header class="mui-bar mui-bar-nav mui-bar-transparent" data-top='0' data-offset='150' data-duration='16'>
				<a class="mui-icon mui-pull-left">
					<img src="../../image/home/message.png" />
				</a>
				<h1 class="mui-title"></h1>
				<a class="mui-icon mui-pull-right">
					<img src="../../image/home/plus.png" />
				</a>
				<a class="mui-icon mui-pull-right" style="margin-right: .5rem;" @tap="onSearchTap()">
					<img src="../../image/home/search.png" />
				</a>
			</header>

			<div class="mui-content noImmersed">
				<!--<div class="mui-scroll">-->

				<div id="slider" class="mui-slider" v-if="imgList.length > 0">
					<div class="mui-slider-group mui-slider-loop">
						<!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
						<div @tap="onAdvertTap(imgLast)" class="mui-slider-item mui-slider-item-duplicate img-lazy-load" :data-src="imgLast.adimg">
							<!--<a href="#">
							<img :src="imgLast.src">
						</a>-->
						</div>

						<!-- 第四张 -->
						<div @tap="onAdvertTap(o)" class="mui-slider-item img-lazy-load" v-for="o, index in imgList" :data-src="o.adimg">
							<a href="#">
								<img :src="o.src">
							</a>
						</div>
						<!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
						<div @tap="onAdvertTap(imgFrist)" class="mui-slider-item mui-slider-item-duplicate img-lazy-load" :data-src="imgFrist.adimg">
							<!--<a href="#">
							<img :src="imgFrist.src">
						</a>-->
						</div>
					</div>
					<div class="mui-slider-indicator">
						<div v-for="o, index in imgList" class="mui-indicator" :class="index === 0 ? 'mui-active':''"></div>
					</div>
				</div>

				<div class="model_type">
					<template v-for="o,i in modelTypes">
						<div @tap="onModelTap(o, i)">
							<img :src="o.src" />
							<span>{{o.name}}</span>
						</div>
					</template>

				</div>

				<div class="device_show">
					<img @tap="openCamListWindow()" src="http://placehold.it/760x350" />
					<div class="dev_status">{{dev.online === 1 ? '在线': '离线'}}</div>
					<div>
						<div class="dev_info">
							<img src="../../image/home/dev_camera.png" /> {{dev.devid}}
						</div>
						<div class="dev_operating">
							<div class="dev_share">
								<img src="../../image/home/dev_share.png" /> 分享
							</div>
							<div class="dev_setting">
								<img src="../../image/home/dev_setting.png" /> 设置
							</div>
						</div>
					</div>
				</div>

				<div class="user_like" v-if="like.length">
					<label class="like_title">猜你喜欢</label>
					<div @tap="onStoreMore()" class="see_more">查看更多 <img src="../../image/home/see_more.png" /></div>
					<div class="like_image">
						
						<template v-for="o,i in like"> 
							<div :style="{backgroundImage: 'url('+o.img+')'}" @tap="onLikeItemTap(o)">
								
								<span>{{o.title}}</span>
							</div>
						</template>
						
						<!--<div>
							<img src="../../image/home/like_a.png" />
							<span>舌尖上的诱惑</span>
						</div>
						<div>
							<img src="../../image/home/like_b.png" />
							<span>周末来嗨呀</span>
						</div>

						<div>
							<img src="../../image/home/like_c.png" />
							<span>限时特惠</span>
						</div>
						<div>
							<span>一起来看红包雨</span>
							<img src="../../image/home/like_d.png" />
						</div>-->

					</div>
				</div>
				<div class="near_shop">
					<label class="near_title">附近的店</label>
					<div @tap="onNearbyMore()"  class="see_more">查看更多 <img src="../../image/home/see_more.png" /></div>
					<div class="shop_image">
						<template v-for="o,i in nearShops">
							<div  @tap="onNearItemTap(o)" class="shop_a" :style="'background-image: url('+ _getImg(o.image1,o.image2,o.image3) +');'"></div>
						</template>

					</div>
				</div>

				<!--</div>-->

			</div>
		</div>
		<!--沉浸式动态处理-->
		<script type="text/javascript" src="../../js/common/immersed.js"></script>

		<!--基础配置-->
		<script type="text/javascript" src="../../js/config.js"></script>
		<!--基础库-->
		<script type="text/javascript" src="../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue-ni.js"></script>
		<!--请求相关-->
		<script type="text/javascript" src="../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../js/dal/user.js"></script>
		<script type="text/javascript" src="../../js/dal/home.js"></script>
		<script type="text/javascript" src="../../js/dal/device.js"></script>
		<script type="text/javascript" src="../../js/dal/store.js" ></script>
		<!--App相关业务逻辑-->
		<script type="text/javascript" src="../../js/app/app.js"></script>
		<script type="text/javascript" src="../../js/app/app-page.js" ></script>

		<!--<script type="text/javascript" src="../../js/plug/test.js" ></script>-->
		<script type="text/javascript" src="../../js/lib/md5.min.js"></script>
		<script type="text/javascript" src="../../js/common/imagelazyload.js"></script>

		<script type="text/javascript" src="../../js/plug/PlugH5NativeBridge.js"></script>

		<script type="text/javascript">
			var advert_cache = new ni.Cache('advert_cache', []);
			
			
			var B = new ni.Broadcast();

			mui.init({
				gestureConfig: {
					longtap: true
				}
			});
			new Vue({
				el: '#approom',
				data: function() {
					return {
						
						imgList: advert_cache.data,
						modelTypes: [{
								name: "回家模式",
								src: "../../image/home/gohome.png"
							},
							{
								name: "离家模式",
								src: "../../image/home/outhome.png"
							},
							{
								name: "回店模式",
								src: "../../image/home/goshop.png"
							},
							{
								name: "离店模式",
								src: "../../image/home/outshop.png"
							}
						],
						dev: {
							"streamfwdport": 17600,
							"location": " 工农兵小吃城2",
							"devid": "AX-DSW-2012102400059",
							"relation": 0,
							"streamfwd": "127.0.0.1",
							"type": 1,
							"signalfwd": "127.0.0.1",
							"signalfwdport": 17700,
							"online": 1
						},
						like: [
							
						],
						
						nearShops: [],
						
						longitude: 0,
						latitude: 0,
						city: '深圳',
					};
				},
				computed: {
					imgFrist: function() {
						return this.imgList[0];
					},
					imgLast: function() {
						return this.imgList[this.imgList.length - 1];
					}
				},
				mounted: function() {
					// 获取轮播广告图
					this.getAdvert();
					//如果用户登录了 则  获取第一个设备
					if(app.user.has()) { 
						this.getDeviceOne();
					}
					// 同时监听登录成功事件
					new this.$Broadcast().on('login_success', function() {
						// 更新获取设备
						this.getDeviceOne();
					}.bind(this));
					
					// 获取喜欢列表
					this.getThemeList();
					
					
					// 动态沉浸式处理
					//					var css = document.createElement('style');
					//					css.innerText = ".mui-slider:before{height:"+ (immersed) +"px;}";
					//					document.body.appendChild(css);
					// 缓存机制加载图片
					imagelazyload();
					// 图片轮播
					mui('#slider').slider({
						interval: 3000 // 自动轮播周期，若为0则不自动播放，默认为0
					});
				},
				plusReady: function() {
					// plus ready ! 现在可以使用plus相关api
					// 设置本页面无滚动条显示
					this.$view.setStyle({
						scrollIndicator: "none", // 隐藏滚动条
						render: "always", // 始终进行渲染
					});
					
					// 获取定位信息
					this.getCurrentPosition().then(function(){
						// 附近的店
						this.getNearShops();
					}.bind(this));
					
					


				},
				methods: {
					getCurrentPosition: function(){
						return new Promise(function(re, rj){
							plus.geolocation.getCurrentPosition(function(p) {
								this.longitude = p.coords.longitude;
								this.latitude = p.coords.latitude;
								this.city = p.address.city.replace('市', '');
								this.position = p.address.poiName;
								re();
							}.bind(this), rj);
						}.bind(this));
					},
					onSearchTap: function(){
						mui.openWindow('../search/index.html', 'search',{
							show: {
								aniShow: 'slide-in-bottom'
							}
						});
					},

					// 当点击模式时
					onModelTap: function(o, index) {
						console.log(JSON.stringify(o));
					},

					openCamListWindow: function() {
						//var rs = plus.plugintest.openCamListWindow(1,2,3);
						//console.log(rs);
						var id = this.dev.id || "AX-DSW-2012102400059";
						plug.H5NativeBridge.StartDevicePlay(id);
					},

					// 获取轮播广告图
					getAdvert: function() {
						dal.home.advert(function(err, data) {
							if(err) {
								return
							}
							this.imgList = data;
							advert_cache.data = data;
							this.$nextTick(function() {
								imagelazyload();
							});
						}.bind(this));
					},
					// 轮播点击
					onAdvertTap: function(o) {
						// 打开内部浏览器
						app.page.openBrowser({
							url: o.adlink 
						});
					},
					// 获取一个设备
					getDeviceOne: function() {
						dal.device.list(1, function(err, data) {
							if(err) {
								return
							}
							this.dev = data[0];

						}.bind(this), 1);
					},
					// 获取喜欢列表
					getThemeList: function() {
						dal.home.theme.get(function(err, data){
							if(err) {
								return 
							}
							this.like = data;
						}.bind(this));
					},
					// 猜你喜欢点击
					onLikeItemTap: function(o){
						// 打开内部浏览器
						app.page.openBrowser({
							url: o.link 
						});
					},
					// 附近的店
					getNearShops: function(){
						dal.store.list(this.longitude, this.latitude, this.city, function(err, data){
							if(err){
								return;
							}
							this.nearShops = data;
						}.bind(this), 1);
					},
					// 附近的店点击
					onNearItemTap: function(o){
						// 店铺
						mui.openWindow('../nearby/business/store_details.html', 'store_details', {
							extras: {
								oid: o.id
							}
						});
					},
					_getImg: function(img1, img2, img3) {
						return img1 || img2 || img3;
					},
					
					
					// 查看猜你喜欢更多
					onStoreMore: function(){
						
						B.emit('tabar', {
							mindex: 2,
							nindex: 1
						}, {
							views: [this.$view.parent()],
						});
					},
					
					// 查看附近的店更多
					onNearbyMore: function(){
						// TODO 主页名称
						B.emit('tabar', {
							mindex: 2,
							nindex: 0
						}, {
							views: [this.$view.parent()],
						});
					},
				}
			});
		</script>
	</body>

</html>