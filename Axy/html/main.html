<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<!--mui css-->
		<link rel="stylesheet" href="../css/lib/mui.min.css" />
		<link rel="stylesheet" href="../css/app/app.css" />
		<style type="text/css">
			nav {
				box-shadow: 0px 0px 0px #ccc !important;
				-webkit-box-shadow: 0px 0px 0px #ccc !important;
				background: white !important;
				padding-top: 5px !important;
			}
			
			.mui-tab-item img {
				width: 2.2rem;
			}
			
			.mui-tab-item span.mui-tab-label {
				font-size: 1.2rem !important;
			}
			
			.mui-bar .mui-icon:active {
				opacity: 1;
			}
		</style>
	</head>

	<body>

		<div id="warp">
			<nav class="mui-bar mui-bar-tab">
				<template v-for="o,i in items">
					<a class="mui-tab-item" :class="{'app-color-active': i === index}" @tap="onTap(o, i)">
						<span class="mui-icon">
							<img :src="'../image/main/'+ o.id + (i === index ? '_active' : '') +'.png'"/>
						</span>
						<span class="mui-tab-label">{{o.name}}</span>
					</a>
				</template>

			</nav>
		</div>

		<!--mui-->
		<script type="text/javascript" src="../js/lib/mui.min.js"></script>
		<!--vue-->
		<script type="text/javascript" src="../js/lib/vue.min.js"></script>
		<!--vue 5+插件-->
		<script type="text/javascript" src="../js/lib/vue-ni.js"></script>

		<script type="text/javascript" src="../js/dal/base.js"></script>
		<script type="text/javascript" src="../js/dal/system.js"></script>
		<script type="text/javascript" src="../js/common/rsmanager.js"></script>
		
		

		<script>
			// 4个子webview统一样式
			var _styles = {
				bottom: '56px',
				top: '0px'
			};
			// 4个子webview参数
			var _items = [{
				url: './home/index.html',
				id: 'home',
				icon: 'mui-icon-home',
				name: '主页',
				styles: _styles,
				extras: {},
			}, {
				url: './smart/index.html',
				id: 'smart',
				icon: 'mui-icon-phone',
				name: '智慧生活',
				styles: _styles,
				extras: {},
			}, {
				url: './nearby/index.html',
				id: 'nearby',
				icon: 'mui-icon-map',
				name: '附近',
				styles: _styles,
				extras: {},
			}, {
				url: './person/index.html',
				id: 'person',
				icon: 'mui-icon-person',
				name: '我的',
				styles: _styles,
				extras: {},
			}];
			
			
			var _B = new ni.Broadcast();
			
			new Vue({
				el: "#warp",
				data: function() {
					return {
						items: _items, // 页面数据
						index: 0, // 默认下标
					}
				},
				mounted: function() {

				},
				plusReady: function() {
					plus.webview.create('zeus.html');
					// plus ready !
					// 这时候才能调用 plus 相关 API
					this.group = new this.$WebviewGroupLow(plus.webview.getLaunchWebview().id, {
						items: this.items,
						onChange: this.onChange.bind(this)
					});
					//仅支持竖屏显示
					plus.screen.lockOrientation("portrait-primary");
					plus.navigator.setStatusBarStyle('UIStatusBarStyleBlackOpaque');

					this._listenLogin();
					this._listenTabar();

				},
				methods: {
					// 点击 tab 图标时
					onTap: function(o, index) {
						if(this.index === index) {
							return;
						}
						// 更新index下标
						this.index = index;
						// 控制webview切换
						this.group.switchTab(o.id);
						// 吐司
						//mui.toast(o.name);
					},
					// 页面切换时
					onChange: function(o) {
						if(this.index === o.index) {
							return;
						}
						this.index = o.index;
						//console.log(o.index);
					},

					// 监听登录成功事件
					_listenLogin: function() {
						_B.on('login_success', function(data) {
							// TODO 登录注册重置密码等页面需要关闭
							var w = null;
							['login', 'reg'].forEach(function(id) {
								w = plus.webview.getWebviewById(id);
								w && w.close();
							});

						});
					},
					// 监听tabar事件
					_listenTabar: function(){
						_B.on("tabar", function(data){
							var target = this.items[data.mindex];
							var t = 0;
							// 如果页面暂时还没打开过
							if(!plus.webview.getWebviewById(target.id)){
								t = 1000;
							}
							// 跳转相应的页面
							this.onTap(this.items[data.mindex], data.mindex);
							// 转发事件
							setTimeout(function(){
								_B.emit("tabar", data, {
									views: [target.id] 
								});
							}, t);
							
							
						}.bind(this));
					}
				}

			});

			setTimeout(function() {
				mui.plusReady(function() {
					function version2number(version) {
						return +(version.split('.').join(''));
					}

					// 获取当前应用版本
					plus.runtime.getProperty(plus.runtime.appid, function(info) {
						var appVersion = version2number(info.version);
						dal.system.update(appVersion, function(err, data) {
							if(err) {
								return mui.toast(err.message);
							}
							var newAppVersion = version2number(data.version);
							if(newAppVersion > appVersion) {
								var filePath = data.path; 
								// 判断是否是更新资源文件
								if(!rsmanager.isHotRresource(filePath)) {
									return mui.alert("非更新资源文件\n" + filePath);
								}
								rsmanager.install(filePath, function(succ) {
									//alert(succ); 
								}, { 
									hide: data.hide, // 是否隐藏更新
									show: data.show, // 是否弹出提示框
									force: data.force, // 强制更新 不能关闭提示框
									title: data.title, // 更新提示框的标题内容 可以设置为app的版本号
									message: data.message // 提示框显示内容，可以设置为app新版内容功能讲解  \n换行
								});
							} else {
								//console.log("无需更新");
							}

						});

					});

				});
				
				//plus.webview.create('zeus.html');
			}, 3000); //3s 后检查更新
			
			
			
			
		</script>
	</body>

</html>