<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>设备列表</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../../js/common/flexible.js"></script>
		<link href="../../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/app/app.css" />
		<link rel="stylesheet" href="../../../css/app/devices.css" />
		<style type="text/css">
			html,
			body,
			.mui-content {
				background-color: #F4F8FB !important;
			}
			
			header>h1>span {
				margin: 0 0.693333rem;
			}
			
			header>h1>span {
				color: #d6f2ef;
			}
			
			header>h1>span.active {
				font-weight: bold;
				color: #FFFFFF;
			}
			
			.mui-table-view-cell>a:not(.mui-btn).mui-active {
				background-color: initial;
			}
			
			ul.a1 {
				margin: 0.346666rem !important;
				border-radius: 3px;
				box-shadow: 0 2px 3px #ededed;
			}
			
			ul.a1 span.left>img {
				width: 0.48rem;
				vertical-align: middle;
			}
			
			ul.a1 span.left>span {
				margin-left: 0.15rem;
				vertical-align: middle;
			}
			
			.nolog {
				text-align: center;
			}
			
			.nolog>.nolog_divimg {
				background-image: url(../../../image/other/icon_Nolog@3x.png);
				background-size: cover;
				background-position: center;
				width: 4rem;
				height: 3.12rem;
				margin: 2.986666rem auto 1.413333rem auto;
			}
			
			.nolog .app-btn-main {
				padding: 0;
				width: 8.373333rem;
				margin: 1.226666rem auto;
				height: 1.173333rem;
				line-height: 1.173333rem;
			}
			
			
			
			.card{
				background-color: #FFFFFF;
				padding: 0.346666rem;
				padding-bottom: 0;
				margin-bottom: 0.266666rem;
			}
			
			.imgdiv{
				height: 4.666666rem;
				width: 9.306666rem;
				background-color: #CCCCCC;
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
				position: relative;
			}
			.imgdiv>span{
				display: inline-block;
				text-align: center;
				width: 0.88rem;
				height: 0.453333rem;
				line-height: 0.453333rem;
				background-color: #9F9FA0;
				color: #FFFFFF;
				border-radius: 5px;
				position: absolute;
				top: 0.266666rem;
				left: 0.266666rem; 
			}
			.imgdiv>span.online{
				background-color: #06C1AE;
			}
			
			
			.menudiv{
				display: flex;
				display: -webkit-flex;
				align-items: center;
				padding: 0.25rem 0.133333rem;
			}
			.menudiv>span{
				flex-grow: 1;
				white-space: nowrap;
				overflow: hidden;
			}
			.menudiv img{
				margin-left: 0.4rem;
				width: 0.773333rem;
				height: 0.773333rem; 
			}
			
		</style>
	</head>

	<body>
		<div id="box">

			<header class="mui-bar mui-bar-nav app-header">
				<a class="mui-action-back app-icon-back mui-pull-left"></a>
				<h1 class="mui-title app-font-size-34">
					<span @tap="onActive(0)" :class="{active: active === 0}">智能主机</span>
					<span @tap="onActive(1)" :class="{active: active === 1}">智能配件</span>
				</h1>
				<a class="app-icon-plus mui-pull-right" @tap="onAddTap()"></a>

			</header>
			<div class="mui-content">

				<template v-if="devList.length">

					<div class="app-font-size-28 a0" v-show="active === 0">
						<div class="card" v-for="o,i in netDivList">
							<div class="imgdiv" @tap="onCmTap(o.devid)" :style="{backgroundImage: 'url('+'file:////storage/emulated/0/CameraFamily/Thumbnail/'+o.devid+'.jpeg'+')'}">
								<span class="app-font-size-20" :class="o.online === 1 ? 'online': ''">{{o.online === 1 ? '在线': '离线'}}</span>
							</div>
							<div class="menudiv">
								<span class="app-color-main">{{_net2local(o.devid).basicInfo.devName}}</span>
								<img src="../../../image/smart/camera/controller.png"/>
								<img src="../../../image/smart/camera/history.png"/>
								<img src="../../../image/smart/camera/share.png"/>
								<img @tap="onSettingTap(o)" src="../../../image/smart/camera/setting.png"/>
							</div>
							
						</div>
					</div>
					<div v-show="active === 1">
						<ul class="mui-table-view app-font-size-28 a1" v-for="o,i in zones">
							<li class="mui-table-view-cell" @tap="onZoneTap(o)">
								<a>
									<span class="left app-font-size-28 app-color-333333">
								<img src="../../../image/smart/scenes/icon_Timing start@3x.png"/>
								<span>{{o.zoneName}}</span>
									</span>
									<span class="mui-badge"><div class="mui-switch mui-switch-mini app-switch-main" @tap.stop="" :class="'mui-active'">
								<div class="mui-switch-handle"></div>
							</div></span>
								</a>
							</li>
							<li class="mui-table-view-cell">
								<a>
									<span class="app-font-size-28 app-color-9f9fa0">
								主机: {{o.bdevName}}
							</span>
									<span class="mui-badge app-color-main">运行正常</span>
								</a>
							</li>
						</ul>
					</div>
				</template>
				<template v-else>
					<div class="nolog">
						<div class="nolog_divimg"></div>
						<div class="app-font-size-30 app-color-9f9fa0">
							这里空空如也， 快去商城挑挑看吧 ~
						</div>
						<button type="button" class="mui-btn app-btn-main app-font-size-34" @tap="onGoShop()">去商城逛逛</button>
					</div>
				</template>
			</div>
		</div>

		<!--沉浸式动态处理-->
		<script type="text/javascript" src="../../../js/common/immersed.js"></script>

		<!--基础库-->
		<script type="text/javascript" src="../../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue-ni.js"></script>
		<!--App相关业务逻辑-->
		<script type="text/javascript" src="../../../js/app/app.js"></script>
		<script type="text/javascript" src="../../../js/app/app-page.js" ></script>
		<script type="text/javascript" src="../../../js/app/app-page.js" ></script>
		

		<script type="text/javascript" src="../../../js/plug/PlugDevManager.js"></script>
		<script type="text/javascript" src="../../../js/plug/PlugH5NativeBridge.js" ></script>
		
		<script type="text/javascript">
			mui.init();
			var devManager, runManager;
			
			var B = new ni.Broadcast();
			
			new Vue({
				el: '#box',
				data: function() {
					return {
						active: 0,
						
						devList: [],
						runList: [],
						
						
						
						netDivList: [],

					};
				},

				computed: {
					zones: function() {
						var z = [];
						this.devList.forEach(function(item) {
							z.push.apply(z, (function(o) {
								return o.zones.map(function(_item) {
									_item.bdevid = o.basicInfo.devid;
									_item.bdevName = o.basicInfo.devName;
									return _item;
								});
							}(item)));
						});

						return z;
					},
					dirs: function(){
						return this.devList.reduce(function(o, item){
							o[item.basicInfo.devid] = item;
							return o;
						}, {});	
					},
					dirr: function(){
						return this.runList.reduce(function(o, item){
							o[item.devid] = item;
							return o;
						}, {});	
					}
				},

				plusReady: function() {
					
					// 本地 所有设备的信息
					var ALLD = new ni.Cache('AllDeviceInfo', [], {
						plus: true
					});

					// 本地 所有设备的运行状态
					var ALLR = new ni.Cache('AllDeviceRun', [], {
						plus: true
					});

					devManager = new DevManager(ALLD);
					runManager = new DevManager(ALLR);
					
					var DEVD = new ni.Cache('dev_list', [], {
						plus: true
					});
					
					this.netDivList = DEVD.data;
					
					
					this.devList = devManager.get();
					
					
					this.runList =  runManager.get();
           
//					setTimeout(function(){
//						var id = this.netDivList[0].devid;
//						alert(JSON.stringify(this.dirs[id]));
//						alert(JSON.stringify(devManager.selectByWhere(function(o){
//							return o.basicInfo.devid === id;
//						})));
//					}.bind(this), 3000);
					
					this.$nextTick(function(){
						mui('.mui-switch')['switch']();
					});
					
					// 监听zeus.html发布的消息
					//B.on('')

				},
				methods: {
					// 摄像机点击
					onCmTap: function(id) {
						plug.H5NativeBridge.StartDevicePlay(id);
					},
					
					// 空空如也 
					onGoShop: function() {

					},
					// 标签切换
					onActive: function(index) {
						this.active = index;
					},
					// 添加配件点击
					onAddTap: function() {
						mui.openWindow('../add/add_device.html');
					},
					// 智能配件点击
					onZoneTap: function(o) {
						var type = this._getZoneType(o.ID);
						console.log(type);
						//type = 17;
						// 打开详情页
						app.page.openForResultBy('dev_'+ type +'.html','dev_' + type, function(data){
							console.log(JSON.stringify(data));
						},{
							info: o 
						});
					},
					// 通过网络设备id获取本地设备信息
					_net2local: function(devid){
						return this.dirs[devid];
					},
					// 通过网络设备id获取本地设备运行状态
					_net2run: function(devid){
						return this.dirr[devid];
					},
					// 通过配件ID获取 配件的类型
					_getZoneType: function(zonedevid){
						return zonedevid.toString().substr(0, 2);
					},
					
					
					
					// 设备设置
					onSettingTap: function(o){
						mui.openWindow('camera_settings.html', 'camera_settings', {
							extras: {
								localInfo: this._net2local(o.devid),
								runInfo: this._net2run(o.devid),
								netInfo: o
							}
						});
					}
				}
			});
			
			
		</script>
	</body>

</html>