<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>设备列表</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script type="text/javascript" src="../../../js/common/flexible.js"></script>
		<link href="../../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../css/app/app.css" />
		<link rel="stylesheet" href="../../../css/app/devices.css" />

		<link rel="stylesheet" href="../../../css/lib/mui.picker.css" />
		<link rel="stylesheet" href="../../../css/lib/mui.poppicker.css" />
		<link rel="stylesheet" href="../../../css/app/module/poppicker.css" />

		<style type="text/css">
			html,
			body,
			.mui-content {
				background-color: #F4F8FB !important;
			}
			
			header>h1>span {
				margin: 0 0.693333rem;
			}
			
			header>h1>span {
				color: #d6f2ef;
			}
			
			header>h1>span.active {
				font-weight: bold;
				color: #FFFFFF;
			}
			
			.mui-table-view-cell>a:not(.mui-btn).mui-active {
				background-color: initial;
			}
			
			ul.a1 {
				margin: 0.346666rem !important;
				border-radius: 3px;
				box-shadow: 0 2px 3px #ededed;
			}
			
			ul.a1 span.left>img {
				width: 0.48rem;
				vertical-align: middle;
			}
			
			ul.a1 span.left>span {
				margin-left: 0.15rem;
				vertical-align: middle;
			}
			
			.nolog {
				text-align: center;
			}
			
			.nolog>.nolog_divimg {
				background-image: url(../../../image/other/icon_Nolog@3x.png);
				background-size: cover;
				background-position: center;
				width: 4rem;
				height: 3.12rem;
				margin: 2.986666rem auto 1.413333rem auto;
			}
			
			.nolog .app-btn-main {
				padding: 0;
				width: 8.373333rem;
				margin: 1.226666rem auto;
				height: 1.173333rem;
				line-height: 1.173333rem;
			}
			
			.card {
				background-color: #FFFFFF;
				padding: 0.346666rem;
				padding-bottom: 0;
				margin-bottom: 0.266666rem;
			}
			
			.imgdiv {
				height: 4.666666rem;
				width: 9.306666rem;
				background-color: #CCCCCC;
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
				position: relative;
			}
			
			.imgdiv.WG-100:after {
				content: "";
				position: absolute;
				width: 100%;
				height: 100%;
				background-image: url(../../../image/smart/devices/bg/wg_100@3xweb.png);
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
				z-index: 8;
			}
			/*TODO 修复*/
			
			.imgdiv.AX-903:after {
				content: "";
				position: absolute;
				width: 100%;
				height: 100%;
				background-image: url(../../../image/smart/devices/bg/903@3xweb.png);
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
				z-index: 8;
			}
			
			.imgdiv.AX-904:after {
				content: "";
				position: absolute;
				width: 100%;
				height: 100%;
				background-image: url(../../../image/smart/devices/bg/904@3xweb.png);
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
				z-index: 8;
			}
			
			.imgdiv.WG-100,
			.imgdiv.AX-903,
			.imgdiv.AX-904 {
				pointer-events: none;
			}
			
			.imgdiv>span {
				display: inline-block;
				text-align: center;
				width: 0.88rem;
				height: 0.453333rem;
				line-height: 0.453333rem;
				background-color: #9F9FA0;
				color: #FFFFFF;
				border-radius: 5px;
				position: absolute;
				top: 0.266666rem;
				left: 0.266666rem;
				z-index: 9;
			}
			
			.imgdiv>span.online {
				background-color: #06C1AE;
			}
			
			.menudiv {
				display: flex;
				display: -webkit-flex;
				align-items: center;
				padding: 0.25rem 0.133333rem;
			}
			
			.menudiv>span {
				flex-grow: 1;
				max-width: 50% !important;
				white-space: nowrap;
				overflow: hidden;
			}
			
			.menudiv img {
				margin-left: 0.4rem;
				width: 0.773333rem;
				height: 0.773333rem;
			}
			/*控制弹窗*/
			
			#controll {
				position: fixed;
				border-radius: 0;
				left: 0;
				bottom: 0;
				width: 100%;
				background-color: #F4F8FB;
			}
			
			#controll .qmenu {
				padding: 1.253333rem 0.826666rem;
				background-color: #FFFFFF;
			}
			
			#controll div.qmenu>div {
				text-align: center;
				display: inline-block;
				width: 22.5%;
				/*float: left;*/
			}
			
			#controll>div.qmenu img {
				width: 1.466666rem;
				margin-bottom: 0.3rem;
			}
		</style>
	</head>

	<body>

		<div id="controll" class="mui-popover">
			<div class="qmenu">

				<div @tap="onTap(1)">
					<img src="../../../image/smart/devices/btn_sos@3x.png" />
					<h5 class="app-font-size-24">求救</h5>
				</div>
				<div @tap="onTap(8)">
					<img src="../../../image/smart/devices/btn_Deploytroopsfordefence@3x.png" />
					<h5 class="app-font-size-24">布防</h5>
				</div>
				<div @tap="onTap(4)">
					<img src="../../../image/smart/devices/btn_Disarm@3x.png" />
					<h5 class="app-font-size-24">撤防</h5>
				</div>
				<div @tap="onTap(2)">
					<img src="../../../image/smart/devices/btn_Mute@3x.png" />
					<h5 class="app-font-size-24">静音</h5>
				</div>

			</div>

			<div class="app-font-size-28" style="height: 1.333333rem;line-height: 1.333333rem;clear: both;text-align: center; margin-top: 0.266666rem;background-color: #FFFFFF;">
				<a href="#controll" class="app-color-333333">取消</a>
			</div>

		</div>

		<div id="box">

			<header class="mui-bar mui-bar-nav app-header">
				<a class="mui-action-back app-icon-back mui-pull-left"></a>
				<h1 class="mui-title app-font-size-34">
					<span @tap="onActive(0)" :class="{active: active === 0}">智能主机</span>
					<span @tap="onActive(1)" :class="{active: active === 1}">智能配件</span>
				</h1>
				<a class="app-icon-plus mui-pull-right" @tap="onAddTap()"></a>

			</header>

			<div class="mui-content">

				<template v-if="netDivList.length">

					<div class="app-font-size-28 a0" v-show="active === 0">
						<div class="card" v-for="o,i in netDivList">
							<div class="imgdiv" :class="_getDevName(o.type)" @tap="onCmTap(o)" :style="{backgroundImage: 'url('+o.devimg+')'}">
								<span class="app-font-size-20" :class="o.online === 1 ? 'online': ''">{{o.online === 1 ? '在线': '离线'}}</span>
							</div>
							<div class="menudiv">
								<span class="app-color-main">{{_fixDevLocation(o.location) || o.devid}}</span>
								<img @tap="onControlTap(o, i)" src="../../../image/smart/camera/controller.png" />
								<img @tap="onAlbmTap(o,i)" src="../../../image/smart/camera/history.png" />
								<img @tap="onShareTap(o,i)" src="../../../image/smart/camera/share.png" />
								<img @tap="onSettingTap(o, i)" src="../../../image/smart/camera/setting.png" />
							</div>

						</div>
					</div>
					<div v-show="active === 1">
						<ul class="mui-table-view app-font-size-28 a1" v-for="o,i in devaccessroyList">
							<li class="mui-table-view-cell" @tap="onZoneTap(o, i)">
								<a class="mui-navigate-right">
									<span class="left app-font-size-28 app-color-333333">
								<img src="../../../image/smart/scenes/icon_Timing start@3x.png" v-if="iconList[o.type] == null"/>
								<img :src="'../../../image/smart/scenes/dev_icons/'+iconList[o.type]" v-if="!(iconList[o.type] == null)"/>
								<span>{{o.name}}</span>
									</span>
									<span class="mui-badge" :class="o.enable && 'app-color-main'">{{o.enable ? "已启用" : "未启用"}}</span>
								</a>
							</li>
							<li class="mui-table-view-cell">
								<a>
									<span class="app-font-size-28 app-color-9f9fa0">
								主机: {{_fixDevLocation(o.devname) || o.devid}}
							</span>
									<span class="mui-badge app-color-main">{{_getStateByCode(o.statuscode)}}</span>
								</a>
							</li>
						</ul>
					</div>
				</template>
				<template v-else>
					<div class="nolog">
						<div class="nolog_divimg"></div>
						<div class="app-font-size-30 app-color-9f9fa0">
							这里空空如也， 快去商城挑挑看吧 ~
						</div>
						<button type="button" class="mui-btn app-btn-main app-font-size-34" @tap="onGoShop()">去商城逛逛</button>
					</div>
				</template>
			</div>
		</div>

		<!--沉浸式动态处理-->
		<script type="text/javascript" src="../../../js/common/immersed.js"></script>

		<!--基础库-->
		<script type="text/javascript" src="../../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/vue-ni.js"></script>

		<script type="text/javascript" src="../../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../../js/dal/devparam.js"></script>
		<script type="text/javascript" src="../../../js/dal/devaccessory.js"></script>

		<!--App相关业务逻辑-->
		<script type="text/javascript" src="../../../js/app/app.js"></script>
		<script type="text/javascript" src="../../../js/app/app-page.js"></script>
		<script type="text/javascript" src="../../../js/app/app-dev.js"></script>

		<script type="text/javascript" src="../../../js/plug/PlugDevManager.js"></script>
		<script type="text/javascript" src="../../../js/plug/PlugH5NativeBridge.js"></script>

		<script type="text/javascript" src="../../../js/lib/mui.picker.js"></script>
		<script type="text/javascript" src="../../../js/lib/mui.poppicker.js"></script>

		<script type="text/javascript" src="../../../js/lib/Rx.min.js"></script>

		<script type="text/javascript">
			mui.init();
			var devManager, runManager;

			var _B = new ni.Broadcast();

			var wayPick;

			var __stateCodearr = ["正常", "失联", "失压"];

			var menuV = new Vue({
				el: '#controll',
				methods: {
					onTap: function(state) {
						plus.nativeUI.showWaiting();
						var dev = listV.controlDev;
						dal.devparam.remotecontrol(dev.devid, dev.type, state, function(err, rs) {
							plus.nativeUI.closeWaiting();
							if(err) {
								console.log(JSON.stringify(err));
								return mui.toast("操作失败, 请检查设备");
							}
							mui.toast("操作成功");
							mui('#controll').popover('hide');
						});
					}
				}

			});

			var listV = new Vue({
				el: '#box',
				data: function() {
					return {
						active: 0,
						controlIndex: -1,
						netDivList: [],

						tapIndex: -1,

						// 配件列表
						devaccessroyList: [],

						iconList: {
							"20": "btn_Warningsign@3x.png",
							"21": "btn_Intelligentsocket@3x.png",
							"22": "btn_Formaldehydedetector@3x.png",
							"32": "btn_Greetingdevice@3x.png",
							"41": "btn_Acousto-opticalarm@3x.png",
							"48": "btn_Emergencybutton@3x.png",
							"52": "btn_Curtainscontroller@3x.png",
							"65": "btn_Infrareddetector@3x.png",
							"80": "btn_Smokedetector@3x.png",
							"129": "btn_Infrareddetector@3x (2).png",
							"145": "btn_Stealthburglardetector@3x.png",
							"160": "btn_Gasdetector@3x.png",
							"161": "btn_Carbonmonoxidedetector@3x.png"
						},

					};
				},

				computed: {
					controlDev: function() {
						return this.netDivList[this.controlIndex];
					}
				},

				mounted: function() {
					wayPick = new mui.PopPicker({
						layer: 1,
						more: false,
					});

				},

				plusReady: function() {

					var DEVD = new ni.Cache('dev_list', [], {
						plus: true
					});

					var that = this;

					function getDevData() {
						var devData = DEVD.data;
						that.netDivList = devData.map(function(item) {
							item.devimg = that._getDevImg(item.devid);
							//item.location = item.location ? item.location.replace(/<[^<]*>/gi, "") : "";
							return item;
						});
					}

					getDevData();

					_B.on('device_update', function() {
						getDevData();
					});

					this.$nextTick(function() {
						mui('.mui-switch')['switch']();
					});

					_B.on('delete', function() {
						this.netDivList.splice(this.tapIndex, 1);
					}.bind(this));

					_B.on('update', function(data) {
						this.$set(this.netDivList, this.tapIndex, data.info);
					}.bind(this));

				},
				methods: {
					// 摄像机点击
					onCmTap: function(o) {
						var that = this;

						if(o.online !== 1) {
							return mui.toast("设备不在线");
						}

						Rx.Observable.create(function(ob) {
							if(o.type >= 0x1040 && o.type <= 0x1080) {
								// 动态设置设备通道
								wayPick.setData([{
										text: '通道一',
										value: 0
									},
									{
										text: '通道二',
										value: 1
									},
									{
										text: '通道三',
										value: 2
									},
									{
										text: '通道四',
										value: 3
									}
								]);
								// 重置弹出层到第一个通道位置
								wayPick.pickers[0].setSelectedValue(1);
								// 显示通道选择器
								wayPick.show(function(items) {
									ob.next({
										b: items[0].value
									});
								}, function(items) {
									// 取消 或者 隐藏
								});
							} else {
								ob.next({
									b: 0
								});
							}
						}).subscribe(function(data) {
							var w1 = data.b;
							var w2 = o.type === 0x1046 ? 1 : 0;
							plug.H5NativeBridge.StartDevicePlay(o.devid, w1, w2, function() {
								o.devimg = that._getDevImg(o.devid);
							});
						});

					},

					// 空空如也 
					onGoShop: function() {

					},
					// 标签切换
					onActive: function(index) {
						this.active = index;
						if(index === 1 && this.devaccessroyList.length === 0) {
							// 获取配件列表
							this.getDevaccessroyData();
						}
					},
					// 添加配件点击
					onAddTap: function() {
						mui.openWindow('../add/add_device.html');
					},
					// 智能配件点击
					onZoneTap: function(o, i) {
						var that = this;
						var actionDir = {
							del: function() {
								that.devaccessroyList.splice(i, 1);
							},
							update: function(info) {
								that.$set(that.devaccessroyList, i, info);
							},
							unbind: function() {
								that.devaccessroyList.splice(i, 1);
							}
						}
						
						// TODO 修复数据结构问题
						var info = {
							accessory: o,
							devName: o.devname,
							devType: o.devtype,
							statusCode: o.statuscode
						};
						
						app.page.openForResultBy('dev_' + o.type + '.html', 'dev_' + o.type, function(data) {
							actionDir[data.action](data.info);
						}, {
							info: info
						});
					},

					_getDevName: function(type) {
						return app.dev.findName(type);
					},
					_fixDevLocation: function(name){
						return app.dev.fixName(name);
					},
					

					// 设备设置
					onSettingTap: function(o, i) {
						this.tapIndex = i;

						var name = app.dev.findName(o.type);

						var url;
						switch(name) {
							case "WG-100":
								{
									url = "dev_WG-100.html";
									break;
								}

							case "AX-903":
								{
									url = "dev_AX-903.html";
									break;
								}

							case "AX-904":
								{
									url = "dev_AX-904.html";
									break;
								}

							default:
								{
									url = "camera_settings.html";
									break;
								}

						}

						mui.openWindow(url, url, {
							extras: {
								devInfo: o
							}
						});
					},

					// 设备控制
					onControlTap: function(o, i) {
						if(o.online !== 1) {
							return mui.toast("设备不在线");
						}
						this.controlIndex = i;
						mui('#controll').popover('show');
					},

					// 设备分享
					onShareTap: function(o, i) {
						mui.openWindow("../../person/devshare/share.html", 'dev_share', {
							extras: {
								devInfo: o
							}
						});
					},

					// 设备录像
					onAlbmTap: function(o, i) {
						mui.openWindow("../../person/collection/my_camera.html", 'my_camera', {
							extras: {
								devInfo: o
							}
						});
					},

					// 获取配件列表数据
					getDevaccessroyData: function() {

						plus.nativeUI.showWaiting("正在获取配件...");

						dal.devaccessory.allacc(function(err, data) {
							plus.nativeUI.closeWaiting();
							if(err) {
								return mui.toast(err.message);
							}
							console.log(JSON.stringify(data));
							this.devaccessroyList = data;

						}.bind(this));
					},

					onSwipe: function(e, o) {
						console.log(JSON.stringify(e));
					},

					_getDevImg: function(devid) {
						if(this.$os.android) {
							return app.android.getScreenshotByDevId(devid);
						} else if(this.$os.ios) {
							return app.ios.getScreenshotByDevId(devid);
						}
					},

					_getStateByCode: function(code) {
						return __stateCodearr[code];
					}
				}
			});
		</script>
	</body>

</html>