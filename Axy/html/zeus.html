<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>

	<body>
		<script type="text/javascript" src="../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../js/lib/vue-ni.js"></script>

		<script type="text/javascript" src="../js/plug/PlugH5NativeBridge.js"></script>

		<script type="text/javascript" src="../js/app/app.js"></script>

		<script type="text/javascript" src="../js/dal/base.js"></script>
		<script type="text/javascript" src="../js/dal/device.js"></script>

		<script type="text/javascript" src="../js/lib/Rx.min.js"></script>

		<script type="text/javascript">
			/**
			 * H5Native 控制中心
			 */

			var D, P = plug.H5NativeBridge;

			var domain = "www.isee110.com";

			var T = -1;
			var TD = 60e3;
			
			Rx.Observable.create(function(ob) {
				if(window.plus) {
					ob.next();
				} else {
					document.addEventListener('plusready', function() {
						ob.next();
					});
				}
			}).subscribe(function() {
				D = new ni.Cache('dev_list', [], {
					plus: true
				});
			});

			Rx.Observable
				// 原始事件
				.create(function(observer) {
					// 监听登录成功事件
					new ni.Broadcast().on('login_success', function(data) {
						// next
						observer.next(data.userInfo);
					});
					ni.plusReady(function() {
						// 如果已经登录就 next
						app.user.has() && observer.next(app.user.get());
					});
					

				})
				// 获取顶级域名
				.mergeMap(function(user) {
					user = user.account;
					return Rx.Observable
						.create(function(o2) {
							// 有缓存就直接取用
							if(domain) {
								// next
								o2.next(user, domain);
							} else {
								// 暂时模拟延迟获取
								setTimeout(function() {
									domain = '';
									// next
									o2.next(user, domain);
								}, 300);
							}
						});
				})
				// 初始化原生插件
				.mergeMap(function(user, domain) {
					// 判断定时器
					if(T < 0) {
						(function _() {
							// 请求服务端数据 TODO 取消分页
							dal.device.list(1, function(err, data) {
								if(err) {
									return;
								}
								console.log(JSON.stringify(data));
								// 数据不为空时 向原生发送数据
								if(data && data.length > 0) {
									D.data = data;
									P.InitNativeDevList(JSON.stringify(data));
								}
							}, 1000);
							// 递归调用 模拟定时器 60s频率
							T = setTimeout(_, TD);
						}());
					}

					return Rx.Observable
						.create(function(o3) {
							// 向原生注册 控制中心 处理函数回调
							P.InitNativeSysteam(user, domain, function(arg) {
								// next
								o3.next(arg);
							});
						});
				})
				// 消息中心事件
				.subscribe(function(data) {
					console.log("zeus.html : " + JSON.stringify(data));
				});
		</script>
	</body>

</html>