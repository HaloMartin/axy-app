<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>登录</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/app/app.css" />
		<script type="text/javascript" src="../../js/common/flexible.js"></script>
		<style type="text/css">
			html,
			body {
				overflow: hidden;
			}
			
			html,
			body,
			.mui-content {
				background-color: white;
			}
			
			.mui-content {
				padding-bottom: 2rem;
			}
			
			.mui-bar-nav,
			.mui-bar {
				background-color: #FFFFFF;
				box-shadow: 0 0 0 white !important;
			}
			
			.mui-pull-right {
				line-height: 44px;
			}
			
			.app-color-main {
				color: #2bb8aa;
			}
			
			.app-color-gray {
				color: #666666;
			}
			
			div.mui-input-row>img {
				display: block;
				width: 0.64rem;
				height: 0.64rem;
				position: absolute;
				top: 0.44rem;
				left: 0.106666rem;
			}
			
			div.mui-input-row>input {
				padding-left: 1.173333rem;
				height: 100%;
				border: none;
				border-radius: 0;
				border-bottom: 1px solid #CCCCCC;
			}
			
			div.mui-input-row>input::-webkit-input-placeholder {
				color: #CCCCCC;
			}
			
			.mui-content div.mui-input-row {
				display: block;
				width: 8.4rem;
				height: 1.6rem;
				margin: 0 auto;
				position: relative;
			}
			
			.mui-content>img {
				display: block;
				width: 2.186666rem;
				height: 2.186666rem;
				margin: 0.373333rem auto 1.733333rem auto;
			}
			/*登录按钮*/
			
			button.app-btn-main {
				width: 8.4rem;
				height: 1.173333rem;
				margin: 0.8rem 0.826666rem 0.56rem 0.826666rem;
			}
			
			.forget_pwd {
				color: #999999;
				text-align: right;
				padding-right: 0.826666rem;
			}
			
			.forget_pwd>a {
				color: #999999;
			}
			
			.third_party_login {
				/*background-color: #CCCCCC;*/
				margin-top: 1.8rem;
				height: 0.8rem;
			}
			
			.third_party_login {
				color: #999999;
				position: relative;
			}
			/*第三方登录横线*/
			
			.third_party_login:before {
				content: "";
				width: 8.4rem;
				position: absolute;
				left: 0.826666rem;
				top: 50%;
				height: 1px;
				background-color: #999999;
				display: block;
				transform: translateY(-50%) scaleY(0.5);
				-webkit-transform: translateY(-50%) scaleY(0.5);
			}
			/*第三方登录文字*/
			
			.third_party_login>div {
				display: inline-block;
				text-align: center;
				padding: 0 0.2rem;
				position: absolute;
				background-color: white;
				left: 50%;
				top: 50%;
				transform: translate(-50%, -50%);
				-webkit-transform: translate(-50%, -50%);
			}
			
			.third_party_login>div.imgRoom {
				width: 100%;
				margin: 1.5rem 0.36rem;
				padding: 0;
			}
			
			.third_party_login>div.imgRoom>img {
				float: left;
				width: 0.906666rem;
				height: 0.906666rem;
				margin-left: 1.64rem;
			}
			
			.mui-icon {
				font-size: 32px !important;
				font-weight: bold;
				color: #666666 !important;
			}
		</style>
	</head>

	<body>

		<header class="mui-bar mui-bar-nav app-header">
			<a class="mui-action-back mui-icon mui-icon-closeempty mui-pull-left app-color-gray">
			</a>
			<span class="mui-pull-right app-font-size-30 app-color-main" id="reg">新用户注册</span>
		</header>
		<div class="mui-content">

			<img src="../../image/common/login_logo.png" @tap="test()" />

			<div class="mui-input-row app-font-size-30">
				<img src="../../image/common/login_account.png" />
				<input type="text" placeholder="请输入手机号码" v-model="username">
			</div>

			<div class="mui-input-row app-font-size-30">
				<img src="../../image/common/login_pwd.png" />
				<input type="password" placeholder="请输入登录密码" v-model="password">
			</div>

			<!--登录按钮-->
			<button type="button" id="loginBtn" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="正在登录..." class="mui-btn app-btn-main app-font-size-32" @tap="onLoginTap($event)">登录</button>

			<div class="forget_pwd app-font-size-24">
				<a :href="'reset.html?tel='+username">忘记密码</a>
			</div>

			<!--第三方登录-->

			<div class="third_party_login">
				<div class="app-font-size-30">
					第三方账号登录
				</div>
				<div class="imgRoom">
					<img src="../../image/common/login_qq.png" @tap="onOtherLoginTap('qq')" />
					<img src="../../image/common/login_weibo.png" @tap="onOtherLoginTap('sinaweibo')" />
					<img src="../../image/common/login_wechat.png" @tap="onOtherLoginTap('weixin')" />
				</div>
			</div>

		</div>
		<script type="text/javascript" src="../../js/common/immersed.js"></script>

		<script src="../../js/lib/mui.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue.min.js"></script>
		<script type="text/javascript" src="../../js/lib/vue-ni.js"></script>
		<script type="text/javascript" src="../../js/dal/base.js"></script>
		<script type="text/javascript" src="../../js/dal/user.js"></script>
		<script type="text/javascript" src="../../js/dal/system.js" ></script>

		<script type="text/javascript" src="../../js/app/app.js"></script>
		<script type="text/javascript" src="../../js/app/app-page.js"></script>
		<script type="text/javascript" src="../../js/app/app-rules.js"></script>

		<script type="text/javascript" src="../../js/lib/Rx.min.js"></script>

		<script type="text/javascript">
			mui.init({
				//处理窗口关闭前的业务
				beforeback: function() {
					plus.navigator.setStatusBarStyle('light');
					app.page.setResult(null).close();
					return false;
				},
			});

			mui.plusReady(function() {
				plus.navigator.setStatusBarStyle('dark');
			});

			mui.ready(function() {
				// 注册按钮
				document.getElementById("reg").addEventListener('tap', function() {
					mui.openWindow('register.html', 'reg', {
						waiting: {
							autoShow: false
						}
					});
				});
			});

			new Vue({
				el: ".mui-content",
				data: function() {
					return {
						username: '',
						password: '',
						loading: false
					};
				},
				plusReady: function() {
					// 获取到创建者 (webview)
					var opener = this.$view.opener();
					// 获取本地记录帐号 
					this.loadLocalHostAccount();

				},
				methods: {
					loadLocalHostAccount: function() {
						var last_account = window.localStorage.getItem('last_account');
						last_account && (this.username = last_account);
					},
					test: function() {
						this.username = '18718690160';
						this.password = '123456';
					},
					onLoginTap: function(e) {
						var that = this;

						var $getStateFn = function(state) {
							return function(o) {
								that.loading = state;
								return o;
							}
						}

						// 登录前数据验证
						var $loginStateCheck = Rx.Observable.create(function(ob) {
							// 如果正在登录，就直接返回
							if(that.loading) {
								return;
							}
							var errorMessage = app.rules.testBy(/^\w{6,32}$/, that.username, "账号格式不正确") ||
								app.rules.testBy(/^\w{6,20}$/, that.password, "密码长度需6-20位");

							if(errorMessage) {
								return mui.toast(errorMessage);
							}

							ob.next({
								account: that.username,
								pwd: that.password
							});
						});

						// 获取domain
						var $getTopDomain = function(o) {
							var account = o.account;
							return Rx.Observable.create(function(ob) {
								dal.system.getTopMain(account, function(err, data) {
									if(err) {
										return ob.error(err);
									}
									o.domain = data;
									ob.next(o);
								});
							});

						};

						// 进行登录
						var $login = function(o) {
							return Rx.Observable.create(function(ob) {
								dal.user.login(o.account, o.pwd, function(err, data) {
									if(err) {
										return ob.error(err);
									}
									ob.next(data);
								}, o.domain);
							});
						};
						
						// 登录权限验证
						var $loginLockCheck = function(data){
							return Rx.Observable.create(function(ob){
								if(data.lockterminal === 0 || data.validation === 1) {
									// 验证通过
									ob.next(data);
								} else {
									// 跳转页面认证
									// TODO
									mui.toast("帐号已保护，您需要权限认证");
									app.page.openAuthorized(data.account, data.bindmobile, function(rs) {
										if(rs.result) {
											ob.next(data);
										}
									});
								}
							});
						}
						
						// 本地验证帐号密码
						$loginStateCheck
							// 打开loading
							.map($getStateFn(true))
							// 获取登录帐号的domain
							.mergeMap($getTopDomain)
							// 通过domain进行登录
							.mergeMap($login)
							// 修复用户数据
							.map(fixUserData)
							// 关闭loading
							.map($getStateFn(false))
							// 登录权限验证
							.mergeMap($loginLockCheck)
							// 登录成功
							.subscribe(function(data){
								mui.toast("登录成功");
								window.localStorage.setItem('_pwd_', that.password);
								window.localStorage.setItem('login_type', 'pwd');
								// 通知上层
								app.page.setResult(data);
								// 通知全部
								new that.$Broadcast().emit("login_success", {
									userInfo: data
								});
								plus.navigator.setStatusBarStyle('light');
							}, function(err){
								$getStateFn(false)();
								mui.toast(err.message);
							});
							

					

					},
					onOtherLoginTap: function(type) {
						var w = plus.nativeUI.showWaiting();
						var that = this;
						setTimeout(function() {
							plus.nativeUI.closeWaiting();
						}, 1e3);

						new Promise(function(resolve, reject) {
								new that.$OAuth(type, function(err, info) {
									if(err) {
										return reject("请确保您有安装该应用且授权");
									}
									return resolve(info);

								}, that);
							})
							// 单次注销
							.then(function(auth) {
								plus.nativeUI.showWaiting("获取授权信息...");
								var o = {};
								for(var i in auth) {
									if(typeof auth[i] !== 'function') {
										o[i] = auth[i];
									}
								}
								return new Promise(function(re, rj) {
									auth.logout(function() {
										re(o);
									}, rj);
								});

							})
							.then(authInfoAdapter)
							.then(function(info) {
								plus.nativeUI.showWaiting("正在登录...");
								return new Promise(function(resolve, reject) {
									dal.user.ologin(info, function(err, data) {
										if(err) {
											return reject(err);
										}
										return resolve(data);
									});
								});
							})
							.then(function(data) {
								plus.nativeUI.closeWaiting();

								Rx.Observable.create(function(ob) {
									if(data.lockterminal === 0 || data.validation === 1) {
										// 验证通过
										ob.next(data);
									} else {
										// 跳转页面认证
										// TODO
										mui.toast("帐号已保护，您需要权限认证");
										app.page.openAuthorized(data.account, data.bindmobile, function(rs) {
											if(rs.result) {
												ob.next(data);
											}
										});
									}
								}).subscribe(function(data) {
									// 保存
									mui.toast('登录成功');

									data = fixUserData(data);
									window.localStorage.setItem('_pwd_', '123456');
									window.localStorage.setItem('login_type', ({
										qq: 'qq',
										sinaweibo: 'wb',
										weixin: 'wx'
									}[type]));
									// 通知上层
									app.page.setResult(data);
									// 通知全部
									new that.$Broadcast().emit("login_success", {
										userInfo: data
									});

									plus.navigator.setStatusBarStyle('light');
								});

							})
							.catch(function(err) {
								plus.nativeUI.closeWaiting();
								mui.toast(JSON.stringify(err));
							});

					},
					
				},
				watch: {
					loading: function(newVal, oldVal) {
						mui('#loginBtn').button(newVal ? "loading" : "reset");
					}
				}

			});

			function authInfoAdapter(info) {
				var _qq = function(_o) {
						return {
							type: 'qq',
							qqopenid: _o.authResult.openid,
							nickname: _o.userInfo.nickname,
							gender: _o.userInfo.gender,
							province: _o.userInfo.province,
							city: _o.userInfo.city,
							headimgurl: _o.userInfo.figureurl_qq_2
						};
					},
					_sinaweibo = function(_o) {
						return {
							type: 'sinaweibo',
							wbopenid: _o.authResult.openid,
							nickname: _o.userInfo.nickname,
							gender: _o.userInfo.gender === 'm' ? '男' : '女',
							province: _o.userInfo.location.split(' ')[0],
							city: _o.userInfo.location.split(' ')[1],
							headimgurl: _o.userInfo.avatar_large
						};
					},
					_weixin = function(_o) {
						return {
							type: 'weixin',
							wxopenid: _o.userInfo.unionid,
							nickname: _o.userInfo.nickname,
							gender: _o.userInfo.sex === 1 ? '男' : '女',
							province: _o.userInfo.province,
							city: _o.userInfo.city,
							headimgurl: _o.userInfo.headimgurl
						};
					}

				return({
					qq: _qq,
					sinaweibo: _sinaweibo,
					weixin: _weixin
				})[info.id](info);

			}

			// 用户资料整合
			function fixUserData(data) {
				// 绑定手机号
				var bindmobile = data.bindmobile;
				// 是否开启权限验证
				var lockterminal = data.lockterminal;
				// 是否需要登录验证
				var validation = data.validation;
				// 是否是主帐号
				var ismaster = data.ismaster;

				data = data.vihiuser;

				data.bindmobile = bindmobile;
				data.lockterminal = lockterminal;
				data.validation = validation;
				data.ismaster = ismaster;

				return data;

			}
		</script>
	</body>

</html>